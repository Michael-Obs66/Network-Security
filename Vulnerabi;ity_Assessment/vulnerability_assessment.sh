!/bin/bash

# Pastikan tools: nmap, curl, sslscan, awk, grep, sort, column
mkdir -p output

summary_file="output/critical_vulns.txt"
echo -e "Subdomain\tVuln Name\tSeverity\tCVE" > $summary_file

# Fungsi warna terminal
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Fungsi untuk mengubah severity ke angka untuk sorting
severity_to_num() {
    case $1 in
        CRITICAL) echo 1 ;;
        HIGH) echo 2 ;;
        MEDIUM) echo 3 ;;
        LOW) echo 4 ;;
        *) echo 5 ;;
    esac
}

while read subdomain; do
    echo -e "\nChecking $subdomain ..."

    if curl -s --connect-timeout 5 http://$subdomain >/dev/null; then
        echo -e "${GREEN}$subdomain is ACTIVE${NC}"

        # Nmap port scan
        echo "Running Nmap port scan..."
        nmap -Pn -p- $subdomain -oN "output/${subdomain}_ports.txt"
        echo "Open ports:"
        grep "^[0-9]" "output/${subdomain}_ports.txt"

        # SSL scan
        echo "Running SSL scan..."
        sslscan $subdomain > "output/${subdomain}_ssl.txt"

        # Nmap vuln scan
        echo "Running Nmap vulnerability scan..."
        nmap -Pn --script vuln $subdomain -oN "output/${subdomain}_vuln.txt"

        # Parsing vuln scan untuk tabel ringkasan
        awk '
        /VULNERABLE/ {vulnname=$0}
        /Severity/ {sev=$2}
        /CVE/ {cve=$0; print vulnname"\t"sev"\t"cve}
        ' "output/${subdomain}_vuln.txt" >> temp_vuln.txt

    else
        echo -e "${YELLOW}$subdomain is NO-ACTIVE${NC}"
    fi
done < subdomain.txt

# Sorting berdasarkan severity (Critical->High->Medium->Low) dan ambil top 10
awk -F'\t' '{
    if ($2=="CRITICAL") s=1
    else if ($2=="HIGH") s=2
    else if ($2=="MEDIUM") s=3
    else if ($2=="LOW") s=4
    else s=5
    print s"\t"$0
}' temp_vuln.txt | sort -n | cut -f2- | head -n 10 >> $summary_file

rm temp_vuln.txt

# Menampilkan tabel akhir di terminal
echo -e "\n=== Top 10 Critical Vulnerabilities ==="
column -t -s $'\t' $summary_file

# Ringkasan per subdomain
echo -e "\n=== Summary per Subdomain ==="
awk -F'\t' '{count[$1]++} END {for (sub in count) print sub, ": ", count[sub], "critical vulns"}' $summary_file

echo "All done! Detailed output is in ./output/"

